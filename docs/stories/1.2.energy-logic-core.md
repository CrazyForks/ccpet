# Story 1.2: Energy Logic Core

## Status
✅ Completed

## Story
**As a** system,  
**I want** a core energy management module,  
**so that** all other functionality (feeding, state changes) has a unified, reliable data source.

## Acceptance Criteria
1. Create independent energy logic module managing 0-100 energy value
2. Module provides add, decrease, and get current energy functions  
3. Module defines energy thresholds for states (happy, hungry, sick, dead)
4. All core logic must have unit test coverage

## Tasks / Subtasks
- [x] Create enhanced energy management methods in Pet.ts (AC: 1, 2)
  - [x] Add addEnergy() method for token consumption feeding
  - [x] Add decreaseEnergy() method for time decay application
  - [x] Add getCurrentEnergy() method for external energy access
  - [x] Validate all energy operations maintain 0-100 bounds
- [x] Define energy state thresholds in config.ts (AC: 3)
  - [x] Add STATE_THRESHOLDS configuration object
  - [x] Define HAPPY threshold (>=80% energy)
  - [x] Define HUNGRY threshold (>=40% energy) 
  - [x] Define SICK threshold (>=10% energy)
  - [x] Define DEAD threshold (0% energy)
- [x] Implement state expression logic based on thresholds (AC: 3)
  - [x] Update _updateExpression() method to use threshold configuration
  - [x] Map energy levels to appropriate expressions: (^_^), (o_o), (u_u), (x_x)
  - [x] Ensure expression updates when energy changes via observer pattern
- [x] Add comprehensive unit tests for energy logic (AC: 4)
  - [x] Test addEnergy() boundary conditions and validation
  - [x] Test decreaseEnergy() boundary conditions and validation  
  - [x] Test getCurrentEnergy() returns correct values
  - [x] Test state threshold transitions and expression updates
  - [x] Test energy bounds enforcement (0-100 range)
  - [x] Test invalid input handling and error cases

## Dev Notes

### Previous Story Insights
Story 1.1 established the foundational Pet class with IPetState interface and observer pattern implementation. The class already has basic energy management via feed() method, but Story 1.2 requires dedicated energy management methods to provide the clean API other stories will depend on [Source: Previous Story 1.1 completion notes].

### Project Structure
Based on architecture, enhance existing files in these exact locations:
- `src/core/Pet.ts` - Add energy management methods to existing Pet class [Source: architecture/source-tree.md#business-logic-layer]
- `src/core/config.ts` - Add STATE_THRESHOLDS to existing configuration [Source: architecture/source-tree.md#business-logic-layer]
- `src/core/__tests__/Pet.test.ts` - Extend existing test suite with energy logic tests [Source: architecture/source-tree.md#testing-structure]

### Component Implementation Standards
Pet class must follow existing class-based template from Story 1.1 [Source: architecture/component-standards.md]:

**Enhanced Pet Class Template:**
- Must extend existing Pet class without breaking existing functionality
- New energy methods must follow private method naming with _ prefix for internal operations
- All energy operations must maintain IPetState interface compatibility
- Must preserve existing observer pattern with subscribe/unsubscribe/notify methods
- State must remain private with public getState() returning copies
- Must use dependency injection for config and logger (already established)

### State Management Pattern
Follow existing CLI state management implementation [Source: architecture/state-management.md]:
- Pet.ts remains Subject maintaining IPetState with enhanced energy methods
- Energy changes must trigger existing observer notifications via _notify() method
- State immutability must be preserved via getState() copies
- All energy operations must be validated and bounds-checked

### Energy Management Configuration  
Use centralized configuration approach established in Story 1.1 [Source: architecture/coding-standards.md#configuration-centralization]:
- STATE_THRESHOLDS object in `src/core/config.ts`
- Happy expression threshold: >=80% energy (expression: "(^_^)")
- Hungry expression threshold: >=40% energy (expression: "(o_o)")  
- Sick expression threshold: >=10% energy (expression: "(u_u)")
- Dead expression threshold: 0% energy (expression: "(x_x)")
- All thresholds must be configurable constants, not magic numbers

### Error Handling Requirements
All energy methods must implement error handling patterns [Source: architecture/coding-standards.md#error-handling-standards]:
- Wrap energy operations in try-catch blocks
- Log errors using existing Logger.getInstance().error() format
- Implement graceful bounds enforcement for invalid values
- Never allow energy values outside 0-100 range
- Validate input parameters and throw descriptive errors

### Testing Requirements
Extend existing comprehensive unit tests [Source: architecture/testing-strategy.md]:
- Test file location: `src/core/__tests__/Pet.test.ts` (extend existing file)
- Use existing Vitest framework with "Arrange-Act-Assert" pattern
- Follow existing mock structure for dependencies
- Achieve >80% test coverage for new energy logic methods
- Test energy bounds enforcement and state transition behavior
- Test error handling paths and invalid input scenarios

### Tech Stack Requirements
Continue using exact versions from Story 1.1 [Source: architecture/tech-stack.md]:
- TypeScript ~5.x.x for type safety
- esbuild ~0.2x.x for fast compilation  
- Vitest ~1.x.x for testing framework
- No external state management libraries - use existing native TypeScript classes

### Integration Points
Energy module must integrate seamlessly with existing Story 1.1 components:
- Existing feed() method should use new addEnergy() internally
- Existing applyTimeDecay() method should use new decreaseEnergy() internally  
- StatusBarFormatter must continue to work with enhanced energy logic
- PetStorage must continue to persist state with new energy methods

## Testing

### Test Coverage Requirements
- All new energy management methods in `src/core/Pet.ts` must have >80% test coverage
- Extend existing Vitest test suite with comprehensive energy logic tests
- Follow test pyramid: Focus on unit tests for energy logic, some integration tests

### Test File Structure
- Unit tests: `src/core/__tests__/Pet.test.ts` (extend existing file)
- Integration tests: `src/__tests__/integration/PetIntegration.test.ts` (extend existing file)

### Test Requirements for Energy Logic
- Test addEnergy() with valid positive values, boundary conditions (0, 100), and invalid inputs
- Test decreaseEnergy() with valid positive values, boundary conditions, and invalid inputs  
- Test getCurrentEnergy() returns correct values after various operations
- Test state threshold transitions: happy->hungry->sick->dead based on energy levels
- Test energy bounds enforcement prevents values <0 or >100
- Test observer notifications trigger correctly when energy changes
- Mock timer functions for testing energy-based behavior
- Test error handling for invalid input types (non-numbers, negative values, NaN)

### Mock Requirements
Continue using existing mock patterns established in Story 1.1:
- Mock dependencies using vi.fn() and existing test utilities
- Test state immutability by verifying getState() returns different object instances
- Use existing vi.mock() patterns for config and logger dependencies
- Mock observer callbacks to verify notification behavior

### Test Commands
Use existing test commands from Story 1.1:
- `npm test` - Run all tests
- `npm run test:unit` - Run unit tests only
- `npm run test:coverage` - Run tests with coverage report

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
No significant debug issues encountered. All tests passed successfully.

### Completion Notes List
1. Successfully implemented addEnergy(), decreaseEnergy(), and getCurrentEnergy() methods in Pet.ts
2. Added STATE_THRESHOLDS and STATE_EXPRESSIONS configuration objects in config.ts
3. Updated _updateExpression() method to use new threshold-based logic with four states: happy (≥80), hungry (≥40), sick (≥10), dead (<10)
4. Refactored existing feed() and applyTimeDecay() methods to use new energy management methods
5. Added comprehensive unit tests with 80 total tests passing, including boundary conditions, error handling, and state transitions
6. All acceptance criteria met with >80% test coverage achieved

### File List
- src/core/Pet.ts - Enhanced with energy management methods
- src/core/config.ts - Added STATE_THRESHOLDS and STATE_EXPRESSIONS
- src/core/__tests__/Pet.test.ts - Extended with energy logic tests
- src/__tests__/integration/PetIntegration.test.ts - Updated to match new expression logic

## QA Results

### Manual Acceptance Test Document

**文档位置**: `docs/qa/story-1.2-manual-acceptance-tests.md`  
**创建日期**: 2025-08-21  
**状态**: 待执行

### 测试覆盖范围

- ✅ 所有验收标准(AC1-AC4)的详细测试步骤
- ✅ 5个完整测试场景，包含能量管理方法验证、状态阈值验证、现有功能集成验证
- ✅ 单元测试覆盖率验证和CLI端到端功能验证
- ✅ 预期结果和实际结果记录表格
- ✅ 缺陷跟踪和最终验收决策流程

*手工验收测试待QA团队执行*