# Story 1.3: Feeding the Pet

## Status
âœ… Completed

## Story

**As a** developer,  
**I want** my coding activity to be recognized and increase the pet's energy,  
**so that** my work immediately brings positive game feedback and I feel rewarded.

## Acceptance Criteria

1. Extension can monitor coding activity in editor to track Token consumption
2. Token consumption calls energy module's "add" function  
3. Status bar energy bar updates in real-time (or near real-time) to reflect energy increases

## Tasks / Subtasks

- [x] ~~Create token monitoring service in CLI architecture (AC: 1)~~ **DEPRECATED - Replaced with JSONL processing**
  - [x] ~~Create TokenMonitor class to detect coding activity between CLI executions~~ **REMOVED**
  - [x] ~~Implement time-based token consumption estimation using file modification timestamps~~ **REMOVED**
  - [x] ~~Store last execution time to calculate tokens consumed since previous run~~ **REMOVED**
  - [x] ~~Use git diff or file change detection to estimate coding activity~~ **REMOVED**
- [x] **NEW: Implement JSONL transcript processing for true token consumption (AC: 1)**
  - [x] Create JSONL processing utility (`src/utils/jsonl.ts`) to parse Claude Code transcript files
  - [x] Extract actual token metrics from Claude Code API usage data
  - [x] Process input/output tokens from transcript files using `getTokenMetrics()` function
  - [x] Integrate with Claude Code status hook for real-time token data
- [x] Integrate token processing with existing energy management (AC: 2)
  - [x] Extend ClaudeCodeStatusLine class to process Claude Code JSON input via stdin
  - [x] Call Pet.addEnergy() method with actual token consumption from JSONL files
  - [x] Ensure proper error handling for JSONL processing failures
  - [x] Configure token-to-energy conversion rate (10 tokens = 1 energy)
- [x] Implement real-time energy bar updates in CLI output (AC: 3)
  - [x] Modify StatusBarFormatter to use rounded energy bar calculation for better UX
  - [x] Ensure energy bar immediately shows increased energy from token consumption
  - [x] Test that energy increases are visible in Claude Code status line
  - [x] Verify energy changes persist across CLI executions
- [x] Add comprehensive unit tests for JSONL processing and feeding logic (All ACs)
  - [x] Test getTokenMetrics() JSONL parsing and edge cases
  - [x] Test integration between token processing and Pet.addEnergy()
  - [x] Test CLI workflow with stdin input scenarios
  - [x] Test error handling and fallback behavior

## Dev Notes

### Previous Story Insights
Story 1.1 established the foundational CLI architecture with Pet class, StatusBarFormatter, and PetStorage persistence. Story 1.2 enhanced the Pet class with dedicated energy management methods (addEnergy, decreaseEnergy, getCurrentEnergy) and state thresholds. The existing addEnergy() method and observer pattern provide the foundation for feeding functionality [Source: Previous Stories 1.1 and 1.2 completion notes].

### Project Structure
Based on architecture, create/enhance files in these exact locations:
- `src/ccpet.ts` - Enhanced ClaudeCodeStatusLine with JSONL token processing [Source: architecture/source-tree.md#cli-entry-point]
- `src/utils/jsonl.ts` - **NEW**: JSONL processing utility for parsing Claude Code transcript files [Source: architecture/source-tree.md#utility-layer]
- `src/core/Pet.ts` - Use existing addEnergy() method (already implemented in Story 1.2) [Source: architecture/source-tree.md#business-logic-layer]
- ~~`src/services/TokenMonitor.ts`~~ - **REMOVED**: Replaced with JSONL processing approach
- ~~`src/core/config.ts`~~ - **SIMPLIFIED**: Removed TOKEN_MONITOR_CONFIG, using simple conversion rate

### **NEW: JSONL Token Processing Strategy**
Since this integrates with Claude Code's status hook system, implement true token processing through JSONL transcript analysis [Source: https://docs.anthropic.com/en/docs/claude-code/statusline]:
- **Real Token Data**: Process actual input/output token usage from Claude Code API calls via JSONL transcript files
- **Stdin Integration**: Read Claude Code JSON input via stdin containing transcript_path and session metadata
- **Token Extraction**: Parse JSONL files line-by-line to extract usage.input_tokens and usage.output_tokens
- **Conversion Rate**: Simple 10:1 ratio (10 tokens = 1 energy point) for balanced gameplay
- **Fallback Behavior**: Show current pet status when no transcript data is available

### Component Implementation Standards
Follow existing CLI architecture established in Stories 1.1 and 1.2 [Source: architecture/component-standards.md]:

**~~TokenMonitor Service~~ REMOVED - Replaced with JSONL Processing**

**JSONL Processing Utility (`src/utils/jsonl.ts`):**
- Must implement getTokenMetrics() function to parse JSONL transcript files
- Must handle file reading and line-by-line JSON parsing with error resilience
- Must extract usage.input_tokens and usage.output_tokens from Claude Code API responses
- Must follow error handling patterns with try-catch blocks and graceful degradation
- Must return structured TokenMetrics interface with inputTokens, outputTokens, totalTokens

**Enhanced ClaudeCodeStatusLine Class:**
- Must process Claude Code JSON input via stdin instead of command line arguments
- Must integrate JSONL processing using getTokenMetrics() in main execution flow
- Must call Pet.addEnergy() with actual token consumption from transcript analysis
- Must maintain existing state loading, time decay, and saving workflow
- Must handle JSONL processing errors gracefully with fallback to current pet status

### State Management Pattern
Continue using existing CLI state management from Stories 1.1 and 1.2 [Source: architecture/state-management.md]:
- Pet.ts remains the state Subject with enhanced energy management methods
- Token consumption triggers Pet.addEnergy() which notifies observers via existing pattern
- StatusBarFormatter continues to format pet state for CLI output
- State persistence through PetStorage continues unchanged
- All energy changes must maintain 0-100 bounds validation

### **UPDATED: Token-to-Energy Configuration**
Simplified configuration approach for JSONL processing [Source: Current Implementation]:
- **TOKEN_TO_ENERGY_RATE**: Fixed 0.1 conversion rate (10 tokens = 1 energy point)
- **Energy Bounds**: Automatic capping at 100 energy through existing Pet.addEnergy() method
- **No Rate Limiting**: Natural rate limiting through Claude Code usage patterns
- ~~TOKEN_MONITOR_CONFIG~~ **REMOVED**: No longer needed with direct token processing

### **UPDATED: Error Handling Requirements**
All JSONL processing must implement error handling patterns [Source: architecture/coding-standards.md#error-handling-standards]:
- Wrap file system operations and JSONL parsing in try-catch blocks
- Log errors using console.error() for debugging
- Implement graceful fallback if JSONL processing fails (show current pet status)
- Never crash CLI execution due to JSONL processing failures
- Handle malformed JSON lines gracefully (skip and continue parsing)

### **UPDATED: Tech Stack Requirements**
Continue using exact versions from previous stories [Source: architecture/tech-stack.md]:
- TypeScript ~5.x.x for type safety
- Node.js built-in modules (fs, readline, path, os) for JSONL file processing
- esbuild ~0.2x.x for fast compilation  
- Vitest ~1.x.x for testing framework
- No external dependencies for JSONL processing - use native Node.js capabilities

### **UPDATED: Integration Points**
JSONL token processing integrates seamlessly with existing Story 1.1 and 1.2 components:
- Existing Pet.addEnergy() method (implemented in Story 1.2) handles all energy logic
- Existing observer pattern triggers StatusBarFormatter updates automatically  
- Existing PetStorage persists pet state (no token monitor state needed)
- Enhanced CLI execution flow with stdin input processing and JSONL analysis
- Existing error handling and graceful degradation patterns maintained
- **NEW**: Claude Code status hook integration via stdin JSON input

## Testing

### **UPDATED: Test Coverage Requirements**
- All new JSONL processing logic in `src/utils/jsonl.ts` must have >80% test coverage
- Enhanced CLI integration in `src/ccpet.ts` must have comprehensive tests
- Use existing Vitest framework with "Arrange-Act-Assert" pattern from previous stories

### **UPDATED: Test File Structure**
- JSONL utility tests: `src/utils/__tests__/jsonl.test.ts` (new file)
- CLI integration tests: `src/__tests__/ccpet.test.ts` (updated for stdin processing)
- Integration tests: `src/__tests__/integration/PetIntegration.test.ts` (extend existing file)
- ~~Service tests: `src/services/__tests__/TokenMonitor.test.ts`~~ **REMOVED**

### **UPDATED: Test Requirements for JSONL Processing**
- Test getTokenMetrics() with various JSONL file scenarios (valid/invalid JSON, missing files)
- Test token extraction from Claude Code API usage data structures
- Test CLI integration with stdin input processing (JSON and empty input)
- Test error handling for file access failures and malformed JSONL content
- Test token-to-energy conversion calculations and bounds checking
- Test integration with existing Pet.addEnergy() method and state persistence
- Mock filesystem operations (fs.existsSync, fs.createReadStream, readline) for consistent testing
- Test edge cases: empty files, malformed JSON lines, missing usage properties

### **UPDATED: Mock Requirements**
Continue using existing mock patterns from previous stories:
- Mock filesystem operations using vi.mock('fs'), vi.mock('readline')
- Mock Pet.addEnergy() calls to verify correct token consumption integration
- Use vi.fn() for mocking JSONL file reading and parsing operations
- Test state immutability and persistence with simplified pet state
- Mock stdin input processing for Claude Code JSON data testing

### Test Commands
Use existing test commands from previous stories:
- `npm test` - Run all tests
- `npm run test:unit` - Run unit tests only
- `npm run test:coverage` - Run tests with coverage report

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References  
- No critical debug issues encountered
- All unit tests passing
- CLI functionality verified

### **UPDATED: Completion Notes List**
- **MAJOR REFACTOR**: Replaced filesystem/git activity detection with true JSONL token processing
- Successfully implemented JSONL processing utility (`src/utils/jsonl.ts`) for Claude Code transcript analysis
- Enhanced ClaudeCodeStatusLine with stdin input processing and real token consumption
- Removed TokenMonitor service in favor of direct Claude Code API integration
- Simplified configuration (removed TOKEN_MONITOR_CONFIG, using fixed conversion rate)
- Enhanced StatusBarFormatter with rounded energy bar calculation for better UX
- All acceptance criteria met with accurate token tracking
- CLI builds and executes correctly with Claude Code status hook integration
- Real token consumption properly feeds pet via Pet.addEnergy() method

### **UPDATED: File List**

**New Files:**

- src/utils/jsonl.ts - JSONL processing utility for Claude Code transcript analysis
- src/utils/__tests__/jsonl.test.ts - Comprehensive JSONL processing tests

**Modified Files:**

- src/ccpet.ts - Enhanced ClaudeCodeStatusLine with stdin processing and JSONL integration
- src/ui/StatusBar.ts - Fixed energy bar calculation using Math.round() for better UX
- src/core/Pet.ts - Enhanced with lastDecayTime tracking for continuous energy decay
- src/services/PetStorage.ts - Simplified (removed token monitor state, added lastDecayTime support)
- src/__tests__/ccpet.test.ts - Updated for stdin processing and JSONL integration tests

**Removed Files:**

- ~~src/services/TokenMonitor.ts~~ - Replaced with JSONL processing approach
- ~~src/services/__tests__/TokenMonitor.test.ts~~ - No longer needed

## QA Results

Manual acceptance testing documents created:
- English: `docs/qa/story-1.3-manual-acceptance-tests.md`
- Chinese: `docs/qa/story-1.3-manual-acceptance-tests-zh.md`

**Test Coverage:**
- 14 comprehensive test cases covering all acceptance criteria
- Integration testing with Claude Code status line
- Performance and edge case validation
- Error handling and graceful degradation scenarios
- State persistence verification across sessions

**Key Test Areas:**
- Git commit activity detection
- File modification activity detection
- Minimum time between feeds protection
- Energy bounds and limits (0-100%)
- Hybrid detection mode verification
- Configuration parameter testing
- CLI performance requirements

Ready for QA execution and sign-off.