# Story 1.6: A New Beginning

## Status
âœ… Completed

## Story

**As a** developer,  
**I want** a simple way to adopt a new pet after mine has died,  
**so that** I can restart the nurturing experience.

## Acceptance Criteria

1. Provide a command in the IDE command palette (e.g., "Status Pet: Adopt a New Pet")
2. Command is only available when the pet's current state is "dead"
3. After executing the command, the pet's energy and state reset to initial "happy" and full energy

## Tasks / Subtasks

- [x] Implement pet resurrection/reset functionality (AC: 3)
  - [x] Add resetToInitialState() method to Pet class
  - [x] Reset energy to INITIAL_ENERGY (100) 
  - [x] Reset expression to HAPPY expression
  - [x] Reset lastFeedTime and lastDecayTime to current time
  - [x] Reset totalTokensConsumed and accumulatedTokens to 0
  - [x] Trigger state persistence save after reset
- [x] Add command registration for VSCode (AC: 1)
  - [x] Create package.json contribution for "claude-pet.adoptNewPet" command
  - [x] Register command handler in ccpet.ts activation function
  - [x] Implement command callback that calls Pet.resetToInitialState()
- [x] Implement dead state detection and command availability (AC: 2)
  - [x] Add isDead() method to Pet class that checks if energy === 0
  - [x] Add command enablement condition based on pet death state
  - [x] Use VSCode when clause to control command visibility
- [x] Add user feedback and confirmation (All ACs)
  - [x] Show success notification when pet is successfully adopted
  - [x] Optionally add confirmation dialog before resetting
  - [x] Update status bar display immediately after reset
- [x] Add comprehensive testing (All ACs)
  - [x] Unit test resetToInitialState() method behavior
  - [x] Test command registration and availability logic
  - [x] Test dead state detection accuracy
  - [x] Integration test complete adoption workflow

## Dev Notes

### Previous Story Insights
Stories 1.1-1.7 have established the complete pet lifecycle with energy management (Story 1.2), expression changes (Story 1.5), time decay (Story 1.4), token feeding (Story 1.3), and state persistence (Story 1.7). Story 1.6 completes the cycle by enabling pet resurrection.

### Project Structure
Based on architecture, implement in these exact locations:
- `src/core/Pet.ts` - Add resetToInitialState() and isDead() methods [Source: architecture/source-tree.md#business-logic-layer]
- `src/ccpet.ts` - Add VSCode command registration and handling [Source: architecture/source-tree.md#cli-entry-point]
- `package.json` - Add command contribution for VSCode command palette [Source: architecture/source-tree.md#root-configuration]

### Component Implementation Standards
Follow existing CLI architecture established in Stories 1.1-1.7 [Source: architecture/component-standards.md]:

**Pet Class Enhancement (`src/core/Pet.ts`):**
- Must add resetToInitialState() public method that restores pet to initial state
- Must use PET_CONFIG constants for initial values (INITIAL_ENERGY, HAPPY_EXPRESSION)
- Must add isDead() public method that returns boolean based on energy === 0
- Must call existing _updateExpression() and _notify() methods after reset
- Must follow error handling patterns with try-catch blocks
- Must maintain observer pattern notifications

**Extension Integration (`src/ccpet.ts`):**
- Must implement VSCode command registration if running in VSCode environment
- Must add "claude-pet.adoptNewPet" command with proper callback
- Must integrate with existing ClaudeCodeStatusLine class
- Must call Pet.resetToInitialState() and PetStorage.saveState() in sequence
- Must handle both CLI and VSCode extension environments gracefully

**Package.json Configuration:**
- Must add contributes.commands entry for "claude-pet.adoptNewPet"
- Must include proper command title and category
- Must add when clause to control command availability based on dead state
- Must follow VSCode extension contribution point standards

### VSCode Extension Architecture
The project is primarily a CLI tool but may run as VSCode extension:
- Command palette integration via contributes.commands in package.json
- Command registration in extension activation function
- Use of VSCode API for notifications and user interaction
- Conditional code execution based on environment detection

### Error Handling Considerations
- Handle cases where pet is not actually dead when command is triggered
- Graceful degradation if VSCode APIs are not available (CLI mode)
- Proper error messages for failed state reset operations
- State consistency validation after reset operation

### Testing
Unit tests must cover:
- resetToInitialState() restores all pet properties correctly
- isDead() accurately detects death state (energy === 0)
- Command registration and callback execution
- State persistence integration after reset
- Error handling for invalid states

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story draft for pet resurrection feature | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
claude-sonnet-4-20250514

### Completion Notes List
- **FINAL IMPLEMENTATION**: Pet resurrection functionality successfully implemented with VSCode command integration
- Added resetToInitialState() method to Pet class that restores pet to initial state (100 energy, happy expression)
- Added isDead() method to Pet class for accurate death state detection (energy === 0)
- Implemented VSCode command registration for "claude-pet.adoptNewPet" with proper activation function
- Added adoptNewPet() method to ClaudeCodeStatusLine class with dead state validation
- Included VSCode notification support when VSCode API is available
- Command only executes when pet is actually dead, maintaining proper state management
- Added comprehensive unit tests covering all resurrection functionality scenarios
- All 134 tests pass including new pet death and resurrection test cases
- Build successful with TypeScript compilation and VSCode extension contribution point

### File List
- Modified: src/core/Pet.ts - Added isDead() and resetToInitialState() methods
- Modified: src/ccpet.ts - Added adoptNewPet(), isPetDead(), and VSCode extension activation
- Modified: package.json - Added VSCode command contribution for "claude-pet.adoptNewPet"
- Modified: src/core/__tests__/Pet.test.ts - Added comprehensive tests for pet death and resurrection
- Modified: src/__tests__/ccpet.test.ts - Added tests for ClaudeCodeStatusLine adoption functionality
- Created: docs/qa/story-1.6-manual-acceptance-tests.md - Manual acceptance testing procedures

## QA Results

*This section will be populated by the QA agent after implementation*