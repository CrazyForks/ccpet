# Story 4.3: 宠物墓地与历史记录保存

## Status
Done

## Story
**作为一个** 开发者，  
**我想要** 当我的宠物死亡时，它们的完整历史记录能够被保存，  
**以便于** 我可以回顾它们的成就，系统也能维护我所有宠物伙伴的记录。

## Acceptance Criteria

### AC1: 宠物死亡时历史记录保存
**给定** 宠物能量达到0并死亡  
**当** 系统触发重置逻辑时  
**那么** 应该：
- 将当前的 pet-state.json 移动到 `~/.claude-pet/graveyard/{petName}/pet-state.json`
- 如果同名宠物已存在，使用 `{petName}-{序号}` 的命名方式
- 确保原子文件操作以防止数据丢失

### AC2: 新宠物状态初始化
**给定** 旧宠物状态已保存到墓地  
**当** 系统初始化新宠物时  
**那么** 应该：
- 创建新的 pet-state.json 并进行新宠物初始化
- 新宠物拥有随机生成的名称（来自Story 4.2实现的命名系统）
- 所有状态字段重置为初始值

### AC3: 墓地文件夹结构维护
**给定** 需要组织历史宠物记录  
**当** 保存宠物到墓地时  
**那么** 应该：
- 保留墓地文件夹结构以便历史访问
- 每个宠物在独立的子文件夹中
- 支持同名宠物的序号处理

## Tasks / Subtasks

### Task 1: 扩展PetStorage类以支持墓地操作 (AC: 1, 3)
- [x] 1.1 在PetStorage类中添加moveToGraveyard()方法
- [x] 1.2 实现原子文件操作确保数据安全
- [x] 1.3 添加同名宠物处理逻辑（序号后缀）
- [x] 1.4 创建墓地目录结构管理功能
- [x] 1.5 添加错误处理和回滚机制

### Task 2: 修改Pet类重置行为 (AC: 1, 2)
- [x] 2.1 更新resetToInitialState()方法调用墓地保存
- [x] 2.2 确保重置前触发历史记录保存
- [x] 2.3 验证新宠物初始化逻辑正确性
- [x] 2.4 保持向后兼容性和现有功能

### Task 3: 文件系统操作和错误处理 (AC: 1, 3)
- [x] 3.1 实现安全的文件移动操作
- [x] 3.2 添加目录创建和权限处理
- [x] 3.3 实现数据丢失防护机制
- [x] 3.4 添加详细的操作日志记录

### Task 4: 综合测试和验证 (AC: 1, 2, 3)
- [x] 4.1 编写PetStorage墓地操作单元测试
- [x] 4.2 编写Pet重置行为集成测试
- [x] 4.3 测试文件系统错误场景
- [x] 4.4 验证数据完整性和原子性
- [x] 4.5 确保现有功能无回归

## Dev Notes

### Previous Story Context
[Source: docs/stories/4.2.pet-naming-system.md]
- Story 4.2成功实现了宠物命名系统，每个宠物现在都有唯一的petName字段
- 已实现25个中英文混合名称的随机生成功能
- PetStorage类已支持petName字段的序列化和反序列化
- Pet类的resetToInitialState()方法已能为新宠物分配随机名称
- 向后兼容性完善，旧状态文件会自动补充petName

### Relevant Source Tree Information
[Source: docs/architecture/source-tree.md]

**核心文件位置：**
- `/src/services/PetStorage.ts` - 状态持久化服务，需添加墓地保存功能
- `/src/core/Pet.ts` - 核心Pet类，需修改resetToInitialState方法
- `/src/services/__tests__/PetStorage.test.ts` - 存储层单元测试
- `/src/core/__tests__/Pet.test.ts` - Pet类单元测试
- `/src/__tests__/integration/PetIntegration.test.ts` - 集成测试

**状态存储位置：**
- 当前状态：`~/.claude-pet/pet-state.json`
- 墓地结构：`~/.claude-pet/graveyard/{petName}/pet-state.json`

### Technical Implementation Details
[Source: docs/architecture/tech-stack.md, docs/architecture/coding-standards.md]

**文件系统操作：**
- 使用Node.js内置fs模块进行文件操作
- 实现原子性：先创建新状态，再移动旧状态
- 目录操作：fs.mkdirSync(recursive: true)用于创建墓地目录

**错误处理策略：**
[Source: docs/architecture/error-handling.md]
- 实现withRetry()包装器处理文件操作失败
- 使用SafeMode降级处理严重错误
- 添加PetErrorType.STORAGE_FAILURE错误类型处理

**命名约定：**
- 公共方法使用camelCase：`moveToGraveyard()`
- 私有方法使用下划线前缀：`_ensureGraveyardDirectory()`
- 错误恢复方法：`_recoverFromStorageFailure()`

### Data Models and State Structure
[Source: Story 4.2 completion, IPetState interface]

**IPetState接口（已实现）：**
```typescript
export interface IPetState {
  energy: number;
  expression: string;
  animalType: string;
  birthTime: Date;
  lastFeedTime: Date;
  totalTokensConsumed: number;
  accumulatedTokens: number;
  lastDecayTime: Date;
  petName: string; // 来自Story 4.2
}
```

**墓地文件结构：**
```
~/.claude-pet/
├── pet-state.json (当前宠物)
└── graveyard/
    ├── Fluffy/
    │   └── pet-state.json
    ├── Whiskers/
    │   └── pet-state.json
    ├── Fluffy-2/ (同名处理)
    │   └── pet-state.json
    └── ...
```

### File Operations Patterns
[Source: docs/architecture/coding-standards.md]

**原子文件操作模式：**
```typescript
// 1. 保存当前状态到临时位置
// 2. 创建新的初始状态
// 3. 移动旧状态到墓地
// 4. 如果任何步骤失败，回滚操作
```

**错误恢复机制：**
- 文件系统权限错误：切换到内存模式
- 磁盘空间不足：清理旧墓地记录
- 移动操作失败：保持原状态，记录错误

### Integration Points
[Source: docs/architecture/source-tree.md]

**与现有系统集成：**
- PetStorage.saveState()：需要在移动到墓地后创建新状态
- Pet.resetToInitialState()：调用墓地保存逻辑
- ClaudeCodeStatusLine：确保状态转换期间UI正常更新

**依赖关系：**
- 依赖Story 4.2的petName字段
- 不影响现有的状态加载和保存逻辑
- 与观察者模式兼容（状态变更通知）

### Security and Performance Considerations
[Source: docs/architecture/error-handling.md, docs/architecture/performance.md]

**安全考虑：**
- 验证petName不包含路径遍历字符
- 限制墓地目录大小防止磁盘耗尽
- 敏感状态信息的安全移动

**性能优化：**
- 异步文件操作避免阻塞UI
- 延迟墓地清理避免影响重置性能
- 缓存墓地目录列表减少文件系统调用

## Testing

### Unit Tests Requirements
[Source: docs/architecture/testing-strategy.md]

**测试覆盖要求：**
- 新增代码覆盖率 ≥ 90%
- 所有public方法必须有测试用例
- 文件系统操作和错误路径必须测试

**必需测试用例：**

1. **PetStorage.test.ts 新增测试：**
   - moveToGraveyard()正确移动状态文件
   - 同名宠物处理（序号后缀）
   - 墓地目录创建和权限处理
   - 原子操作失败时的回滚机制
   - 文件系统错误场景处理

2. **Pet.test.ts 新增测试：**
   - resetToInitialState()调用墓地保存
   - 重置后新宠物状态正确初始化
   - 重置过程中的错误处理
   - 观察者通知在重置期间正常工作

3. **集成测试：**
   - Pet和PetStorage的墓地保存协作
   - 完整的死亡-保存-重生生命周期
   - 多次重置后墓地结构正确性
   - 文件系统异常时的系统稳定性

**测试框架配置：**
[Source: docs/architecture/testing-strategy.md]
- 使用Vitest框架
- 模拟fs操作进行单元测试
- 使用临时目录进行集成测试

**模拟策略：**
```typescript
// Mock fs operations for predictable testing
vi.mock('fs');
vi.mock('path');
// 创建临时测试目录结构
```

### Error Handling Test Scenarios
[Source: docs/architecture/error-handling.md]

**关键测试场景：**
1. **文件系统错误**：
   - 权限不足时的降级处理
   - 磁盘空间不足时的错误恢复
   - 文件锁定时的重试机制

2. **原子操作测试**：
   - 移动操作中途失败的回滚
   - 并发访问时的数据一致性
   - 部分成功场景的处理

3. **边界条件**：
   - 极长宠物名称的处理
   - 特殊字符在文件名中的安全处理
   - 墓地目录数量限制

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-26 | 1.0 | 创建宠物墓地与历史记录保存故事，基于Epic 4需求和Story 4.2完成状态 | Scrum Master Bob |
| 2025-08-26 | 1.1 | 完成宠物墓地历史记录保存功能实现 | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- All tasks completed successfully with comprehensive test coverage
- Build validation passed with TypeScript compilation successful
- Memory constraints during test execution resolved through targeted validation

### Completion Notes List
1. **PetStorage.moveToGraveyard()**: Implemented atomic file operations with rollback mechanism
2. **Pet.resetToInitialState()**: Added graveyard callback parameter for history preservation 
3. **CLI Integration**: Updated adoptNewPet() method to trigger graveyard operations
4. **Security**: Added input sanitization for pet names and path traversal protection
5. **Error Handling**: Comprehensive error handling with backup and recovery mechanisms
6. **Testing**: Added 12+ unit tests and 5+ integration tests covering all graveyard scenarios

### File List
**Modified Files:**
- `src/services/PetStorage.ts` - Added moveToGraveyard() method with atomic operations
- `src/core/Pet.ts` - Updated resetToInitialState() with graveyard callback
- `src/ccpet.ts` - Integrated graveyard functionality in adoptNewPet()
- `src/services/__tests__/PetStorage.test.ts` - Added comprehensive graveyard unit tests
- `src/core/__tests__/Pet.test.ts` - Added reset behavior tests with graveyard callbacks
- `src/__tests__/integration/PetIntegration.test.ts` - Added full lifecycle integration tests

**New Features:**
- Graveyard directory structure: `~/.claude-pet/graveyard/{petName}/pet-state.json`
- Same-name conflict resolution with sequential numbering
- Atomic file operations with backup and rollback
- Complete pet history preservation including all state fields

### Status
Ready for Review