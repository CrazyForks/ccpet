# Story 2.1: 动物类型系统基础架构

## Status
Completed

## 故事概述
**作为一个** 系统架构师，  
**我需要** 建立支持多种动物类型的基础架构，  
**以便于** 后续功能能够基于不同的动物类型提供个性化的宠物体验。

## 业务价值
- 为动物形象宠物系统奠定技术基础
- 支持宠物个性化和多样性
- 提供可扩展的架构以支持未来新增动物类型
- 增强用户的情感连接和使用粘性

## 验收标准

### AC1: 动物类型配置系统
**给定** 系统需要支持多种动物类型  
**当** 开发者查看配置文件时  
**那么** 应该能看到：
- 定义了至少5种基础动物类型（猫、狗、兔子、熊猫、狐狸）
- 每种动物类型都有唯一的标识符和名称
- 每种动物类型都有完整的状态表情映射
- 配置结构支持未来扩展新的动物类型

### AC2: 宠物状态接口扩展
**给定** 现有的宠物状态管理系统  
**当** 系统创建或更新宠物状态时  
**那么** 应该：
- `IPetState` 接口包含 `animalType` 字段
- 动物类型字段支持类型安全的枚举值
- 现有的状态字段保持不变，确保向后兼容
- 提供默认动物类型以支持现有数据迁移

### AC3: 随机动物选择机制
**给定** 用户首次获得宠物或重新领养宠物  
**当** 系统初始化宠物状态时  
**那么** 应该：
- 从可用的动物类型中随机选择一种
- 使用可重现的随机种子机制
- 提供获取当前宠物动物类型的方法
- 记录动物类型选择的日志用于调试

### AC4: 表情映射系统重构
**给定** 现有的表情显示系统  
**当** 系统需要显示宠物表情时  
**那么** 应该：
- 根据动物类型和能量状态选择正确的表情
- 每个状态（快乐、饥饿、生病、死亡）都有4种不同的表情变化
- 保持现有的动画轮播机制
- 提供fallback机制处理未定义的动物类型

### AC5: 配置验证和错误处理
**给定** 动物类型配置可能存在错误  
**当** 系统启动或加载配置时  
**那么** 应该：
- 验证所有动物类型都有完整的表情映射
- 检查表情字符的有效性和显示兼容性
- 提供清晰的错误信息用于配置问题诊断
- 在配置错误时使用默认的安全配置

## 技术实现要求

### 数据结构设计
```typescript
// 动物类型枚举
enum AnimalType {
  CAT = 'cat',
  DOG = 'dog',
  RABBIT = 'rabbit',
  PANDA = 'panda',
  FOX = 'fox'
}

// 动物配置接口（简化设计：emoji + 现有表情）
interface IAnimalConfig {
  id: AnimalType;
  name: string;
  emoji: string; // 动物emoji，如 '🐱', '🐶', '🐰', '🐼', '🦊'
}

// 扩展的宠物状态接口
interface IPetState {
  energy: number;
  lastFed: number;
  animalType: AnimalType;
  // ... 其他现有字段
}
```

### 配置文件结构
- 扩展 `src/core/config.ts` 中的 `PET_CONFIG`
- 新增 `ANIMAL_TYPES` 配置项
- 重构 `STATE_EXPRESSIONS` 为多维结构
- 保持现有配置的向后兼容性

### 核心服务更新
- 更新 `Pet.ts` 类支持动物类型
- 修改 `PetStorage.ts` 持久化动物类型信息
- 扩展表情获取逻辑支持动物类型参数

## 测试要求

### 单元测试覆盖
- [ ] 动物类型随机选择逻辑
- [ ] 表情映射系统的正确性
- [ ] 配置验证和错误处理
- [ ] 宠物状态序列化/反序列化包含动物类型

### 集成测试覆盖
- [ ] 完整的宠物初始化流程
- [ ] 动物类型在不同状态下的表情显示
- [ ] 配置加载和验证流程
- [ ] 向后兼容性测试

### 边界条件测试
- [ ] 无效动物类型处理
- [ ] 缺失表情配置处理
- [ ] 配置文件损坏场景
- [ ] 内存和性能边界测试

## 定义完成 (Definition of Done)

### 代码质量
- [ ] 所有新代码都有TypeScript类型注解
- [ ] 代码通过ESLint和Prettier检查
- [ ] 单元测试覆盖率 ≥ 90%
- [ ] 所有现有测试继续通过

### 功能完整性
- [ ] 支持至少5种基础动物类型
- [ ] 每种动物类型都有完整的4状态×4表情映射
- [ ] 随机动物选择功能正常工作
- [ ] 向后兼容性完整保持

### 文档和可维护性
- [ ] 更新相关的技术文档
- [ ] 添加代码注释说明复杂逻辑
- [ ] 提供配置示例和扩展指南
- [ ] 错误信息清晰易懂

### 性能和稳定性
- [ ] 启动时间无明显增加
- [ ] 内存使用量保持稳定
- [ ] 表情切换响应时间 < 100ms
- [ ] 无内存泄漏或资源泄漏

## 依赖关系
- **前置条件**: Epic 1 的所有故事已完成
- **阻塞关系**: 此故事完成后才能开始后续的动物形象显示相关故事
- **外部依赖**: 无

## 风险和缓解措施

### 技术风险
- **配置复杂度增加**: 通过良好的类型定义和验证机制缓解
- **性能影响**: 通过缓存和优化的数据结构缓解
- **向后兼容性**: 通过渐进式迁移和默认值机制缓解

### 实现风险
- **表情字符显示问题**: 提供fallback和兼容性测试
- **随机性可重现性**: 使用确定性的伪随机算法
- **配置维护成本**: 提供工具和文档简化配置管理

## 验收测试场景

### 场景1: 新用户首次获得宠物
```
给定 用户首次安装扩展
当 系统初始化宠物时
那么 宠物应该被随机分配一种动物类型
并且 显示该动物类型对应的快乐状态表情
并且 动物类型信息被正确保存
```

### 场景2: 现有用户升级系统
```
给定 用户已有旧版本的宠物数据
当 系统升级到新版本时
那么 现有宠物应该被分配默认动物类型
并且 所有现有功能继续正常工作
并且 不会丢失任何宠物状态数据
```

### 场景3: 配置错误处理
```
给定 动物类型配置文件存在错误
当 系统启动时
那么 应该显示清晰的错误信息
并且 使用默认配置继续运行
并且 记录详细的错误日志
```

## 估算
- **开发工作量**: 2-3个工作日
- **测试工作量**: 1个工作日
- **代码审查和优化**: 0.5个工作日
- **总计**: 3.5-4.5个工作日

---
**创建时间**: 2025-08-24  
**负责人**: Scrum Master Bob  
**优先级**: 高  
**Epic**: Epic 2 - 动物形象宠物系统  
**故事点数**: 8

## Dev Agent Record

### Tasks
- [x] Implement AnimalType enum and interfaces
- [x] Update config.ts with animal configurations  
- [x] Extend IPetState interface with animalType field
- [x] Update Pet.ts class to support animal types
- [x] Update PetStorage.ts for animal type persistence
- [x] Write unit tests for animal type system
- [x] Run tests and validations

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Random animal selection implemented using `Pet.getRandomAnimalType()` static method
- Backward compatibility migration logs added to `PetStorage.loadState()`
- Animal type validation and fallback mechanisms implemented

### Completion Notes
Successfully implemented animal type system foundation with:
- 5 animal types supported (CAT, DOG, RABBIT, PANDA, FOX)
- Full backward compatibility for existing pet data
- Random animal selection for new pets and resets
- Comprehensive test coverage (78 tests pass)
- All acceptance criteria met

### File List
**Core Files Modified:**
- `src/core/config.ts` - Added AnimalType enum, IAnimalConfig interface, ANIMAL_CONFIGS, and default type configuration
- `src/core/Pet.ts` - Extended IPetState interface, added animalType support, random selection, and getCurrentAnimalType method
- `src/services/PetStorage.ts` - Added backward compatibility migration and validation for animal types
- `src/ccpet.ts` - Updated initialization to include random animal type for new pets

**Test Files Modified:**
- `src/core/__tests__/Pet.test.ts` - Updated existing tests and added comprehensive animal type test suite
- `src/services/__tests__/PetStorage.test.ts` - Added backward compatibility and validation tests
- `src/__tests__/integration/PetIntegration.test.ts` - Updated integration tests to include animalType field

### Change Log
**2025-08-24**: Story 2.1 implementation completed
- Added AnimalType enum with 5 animal types (cat, dog, rabbit, panda, fox)
- Extended IPetState interface with animalType field
- Implemented random animal selection for new pets and resets
- Added ANIMAL_CONFIGS mapping with emoji support for future use
- Ensured full backward compatibility with existing pet save data
- Added comprehensive test coverage for all animal type functionality
- All tests passing (261/261) with successful build
