# Story 3.1: 持续宠物监控功能

## Status
Completed

## Story
**作为一个** 开发者，  
**我想要** 在 ccpet check 命令中添加持续监控选项，  
**以便于** 我能够实时观察宠物状态的变化，无需重复手动执行命令。

## Acceptance Criteria

### AC1: Watch参数支持
**给定** 用户想要持续监控宠物状态  
**当** 用户执行 `ccpet check --watch` 或 `ccpet check -w`  
**那么** 应该：
- 立即显示当前宠物状态
- 每60秒自动刷新并显示更新的状态
- 显示清晰的时间戳标识每次更新
- 提供停止监控的提示信息（Ctrl+C）

### AC2: 自定义监控间隔
**给定** 用户想要自定义监控间隔  
**当** 用户执行 `ccpet check --watch --interval 30`  
**那么** 应该：
- 按照用户指定的间隔（30秒）更新状态
- 间隔时间范围：10-300秒（10秒到5分钟）
- 超出范围时显示错误信息并使用默认60秒
- 在监控开始时显示当前使用的间隔时间

### AC3: 优雅的退出处理
**给定** 用户想要停止持续监控  
**当** 用户按下 Ctrl+C  
**那么** 应该：
- 立即停止监控循环
- 显示友好的退出信息
- 清理所有定时器和监听器
- 正常退出程序（exit code 0）

### AC4: 状态变化提醒
**给定** 用户在持续监控期间宠物状态发生变化  
**当** 检测到能量值、表情或动物类型变化时  
**那么** 应该：
- 高亮显示变化的内容
- 显示变化前后的对比信息
- 对关键状态变化（如从健康变为饥饿）提供特殊标识
- 保持与非监控模式相同的显示格式

### AC5: 错误处理和恢复
**给定** 监控过程中可能出现的错误  
**当** 发生临时错误（如文件读取失败）时  
**那么** 应该：
- 显示错误信息但不停止监控
- 在下次更新时尝试重新获取状态
- 连续3次失败后询问用户是否继续
- 严重错误时优雅退出并显示详细错误信息

## Tasks / Subtasks

### Task 1: 扩展CheckCommand参数解析 (AC: 1, 2)
- [x] 1.1 为CheckCommand.execute方法添加参数解析
- [x] 1.2 支持 --watch, -w 标志
- [x] 1.3 支持 --interval N 参数
- [x] 1.4 添加参数验证（10-300秒范围）
- [x] 1.5 更新help信息显示新参数

### Task 2: 实现持续监控逻辑 (AC: 1, 4)
- [x] 2.1 创建监控循环函数
- [x] 2.2 实现定时刷新机制（setInterval）
- [x] 2.3 添加状态变化检测逻辑
- [x] 2.4 实现高亮显示变化内容
- [x] 2.5 添加时间戳显示

### Task 3: 信号处理和优雅退出 (AC: 3)
- [x] 3.1 监听 SIGINT 信号（Ctrl+C）
- [x] 3.2 实现清理函数（清理定时器）
- [x] 3.3 显示友好的退出信息
- [x] 3.4 确保正确的退出代码

### Task 4: 错误处理和恢复机制 (AC: 5)
- [x] 4.1 包装状态获取逻辑try-catch
- [x] 4.2 实现重试计数器
- [x] 4.3 添加用户确认继续监控的提示
- [x] 4.4 区分临时错误和严重错误

### Task 5: 用户体验优化
- [x] 5.1 添加监控开始的欢迎信息
- [x] 5.2 实现清屏功能（可选）
- [x] 5.3 优化终端输出格式
- [x] 5.4 添加监控状态指示器

### Task 6: 测试覆盖
- [x] 6.1 为CheckCommand参数解析编写单元测试
- [x] 6.2 模拟持续监控场景的集成测试
- [x] 6.3 测试信号处理和退出逻辑
- [x] 6.4 测试错误处理和恢复机制
- [x] 6.5 测试参数验证和边界条件

## Dev Notes

### Previous Story Context
- Story 2.2完成了emoji表情显示系统
- 现有的check命令已经能够正确显示宠物状态
- getStatusDisplay()方法提供了完整的状态显示功能

### Relevant Source Tree Information
[Source: docs/architecture/source-tree.md]

**核心文件位置：**
- `/src/commands/CheckCommand.ts` - 现有check命令实现
- `/src/ccpet.ts` - ClaudeCodeStatusLine类和getStatusDisplay方法
- `/src/cli.ts` - 命令行参数解析和路由

**相关依赖：**
- `ClaudeCodeStatusLine` 类提供 getStatusDisplay() 和 saveState() 方法
- Pet状态通过 pet.getState() 获取
- 时间计算逻辑已存在于现有check命令中

### Technical Implementation Details
[Source: architecture/tech-stack.md, architecture/coding-standards.md]

**Node.js 环境相关：**
- 使用 process.on('SIGINT') 监听Ctrl+C
- setInterval/clearInterval 管理定时器
- console.clear() 可选的清屏功能
- process.exit() 处理退出

**TypeScript 类型定义：**
```typescript
interface CheckCommandOptions {
  watch?: boolean;
  interval?: number;
}
```

**参数解析模式：**
- 继续使用现有的 args: string[] 参数
- 解析 --watch, -w, --interval 参数
- 参考ConfigCommand的参数解析模式

### Testing Strategy
[Source: docs/architecture/testing-strategy.md]

**测试文件位置：** `src/commands/__tests__/CheckCommand.test.ts`

**测试框架：** Jest
**测试类型：**
- 单元测试：参数解析、逻辑验证
- 集成测试：与Pet系统的交互
- 边界测试：参数验证、错误条件

**模拟策略：**
- Mock setInterval/clearInterval
- Mock console.log/console.clear
- Mock process.on/process.exit
- Mock ClaudeCodeStatusLine

**覆盖要求：**
- 新增代码覆盖率 ≥ 90%
- 所有错误分支必须测试
- 信号处理逻辑必须测试

### Configuration Integration
[Source: docs/architecture/environment-configuration.md]

**可能的配置扩展：**
- 默认监控间隔配置
- 清屏功能开关配置
- 变化高亮显示配置

现阶段不需要新增配置项，但要确保与现有ConfigService兼容。

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### File List
**Modified Files:**
- `src/commands/CheckCommand.ts` - Enhanced with watch mode, parameter parsing, signal handling
- `src/commands/__tests__/CheckCommand.test.ts` - Added comprehensive test coverage (21 new test cases)

**No new files created** - All functionality added to existing CheckCommand

### Debug Log References
All implementation proceeded without debugging issues. Tests passed on first run after TypeScript syntax fixes.

### Completion Notes
✅ **All acceptance criteria fully implemented:**
- AC1: Watch parameter support with --watch/-w flags and 60s default interval
- AC2: Custom interval support with --interval parameter and 10-300s validation  
- AC3: Graceful exit handling with Ctrl+C support and proper cleanup
- AC4: State change highlighting with energy/expression/animal type detection
- AC5: Error handling with retry count and graceful degradation

✅ **Technical implementation highlights:**
- Proper TypeScript interfaces and error handling
- Comprehensive signal handling (SIGINT) with cleanup
- Real-time state comparison and change highlighting
- Robust parameter validation and help system
- Memory leak prevention with timer cleanup

✅ **Test coverage:** 21 new test cases covering all functionality
✅ **Build status:** Clean compilation, all tests passing (290/290)

### Error Handling Standards
[Source: docs/architecture/error-handling.md]

**错误分类：**
1. **参数错误**：间隔时间超出范围
2. **临时错误**：文件读取失败、状态获取失败
3. **严重错误**：系统异常、内存不足等

**错误恢复策略：**
- 参数错误：显示错误并使用默认值
- 临时错误：重试机制，3次后询问用户
- 严重错误：优雅退出并记录错误

### Performance Considerations
[Source: docs/architecture/performance.md]

**性能要求：**
- 监控循环不应占用过多CPU
- 内存泄漏预防（清理定时器）
- 避免频繁的磁盘I/O

**优化策略：**
- 状态比较只在真正变化时进行高亮
- 合理使用setTimeout替代setInterval避免堆积
- 缓存前一次状态用于变化比较

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-24 | 1.0 | 创建持续监控功能故事 | Scrum Master Bob |
| 2025-08-24 | 1.1 | 实现所有功能，添加测试覆盖，完成开发 | Dev Agent James |