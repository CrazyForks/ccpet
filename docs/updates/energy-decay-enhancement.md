# 能量衰减机制优化 - 分钟级精细化管理

## 更新概述

**日期**: 2025-08-22  
**版本**: 故事1.3后优化  
**影响范围**: 宠物能量衰减系统

## 变更内容

### 原有机制
- **衰减单位**: 按小时计算
- **衰减率**: 每小时减少5点能量
- **完全衰减时间**: 20小时(100÷5)
- **精度**: 整数能量值

### 新机制
- **衰减单位**: 按分钟计算  
- **衰减率**: 每分钟减少约0.0231点能量 (100÷4320)
- **完全衰减时间**: 3天(4320分钟)
- **精度**: 支持小数能量值 (例如: 95.5)

## 技术实现

### 核心算法更新
```typescript
// 原有逻辑
const hoursSinceLastFeed = Math.floor(
  (now.getTime() - this.state.lastFeedTime.getTime()) / (1000 * 60 * 60)
);
if (hoursSinceLastFeed > 0) {
  this.decreaseEnergy(hoursSinceLastFeed * 5);
}

// 新逻辑  
const minutesSinceLastFeed = 
  (now.getTime() - this.state.lastFeedTime.getTime()) / (1000 * 60);
if (minutesSinceLastFeed > 0) {
  const ENERGY_DECAY_PER_MINUTE = 100 / (3 * 24 * 60); // ≈ 0.0231
  const energyDecay = minutesSinceLastFeed * ENERGY_DECAY_PER_MINUTE;
  if (energyDecay > 0) {
    this.decreaseEnergy(energyDecay);
  }
}
```

### 衰减时间表
| 时间间隔 | 能量损失 | 剩余能量(从100开始) |
|---------|---------|-------------------|
| 1分钟    | 0.02点   | 99.98            |
| 1小时    | 1.39点   | 98.61            |
| 12小时   | 16.67点  | 83.33            |
| 1天      | 33.33点  | 66.67            |
| 2天      | 66.67点  | 33.33            |
| 3天      | 100点    | 0 (完全衰减)      |

## 用户体验改进

### 更精细的反馈
- **实时感知**: 每次CLI执行都能感受到细微的能量变化
- **渐进衰减**: 避免突然的大幅能量下降
- **合理节奏**: 3天衰减期符合现实工作节奏

### 游戏平衡性
- **短期离开**: 1-2小时离开影响很小
- **日常休息**: 过夜休息损失约1/3能量
- **周末休息**: 2-3天不编程会让宠物明显虚弱

## 兼容性

### StatusBarFormatter
- 已支持小数能量值处理
- 使用`Math.floor`确保能量条显示为整数段
- 无需修改显示逻辑

### 状态持久化
- 能量值以`number`类型存储，天然支持小数
- JSON序列化/反序列化无需更改
- 向后兼容现有状态文件

## 测试更新

### 单元测试调整
- 更新了`Pet.test.ts`中的衰减测试用例
- 使用`toBeCloseTo()`匹配小数精度
- 验证分钟级计算的准确性

### 集成测试优化
- 调整了状态转换测试的时间参数
- 确保测试覆盖新的衰减时间表
- 维持98个测试用例全部通过

## 配置建议

### 开发环境
推荐配置短时间间隔进行测试：
```typescript
const ENERGY_DECAY_PER_MINUTE = 100 / (30); // 30分钟完全衰减（仅测试用）
```

### 生产环境
当前3天衰减配置适合大多数用户：
```typescript
const ENERGY_DECAY_PER_MINUTE = 100 / (3 * 24 * 60); // 3天完全衰减
```

## 性能影响

- **计算复杂度**: 从整数除法改为浮点数运算，性能影响微乎其微
- **内存使用**: 浮点数存储略微增加，可忽略不计
- **执行时间**: CLI执行时间保持在<100ms要求内

## 未来扩展

### 可配置衰减率
考虑在`config.ts`中添加可配置的衰减参数：
```typescript
export const PET_DECAY_CONFIG = {
  FULL_DECAY_DAYS: 3,           // 完全衰减天数
  ENABLE_MINUTE_PRECISION: true  // 是否启用分钟级精度
} as const;
```

### 动态衰减率
未来可考虑根据宠物状态调整衰减速度：
- 高能量时衰减较慢
- 低能量时衰减加速
- 根据历史活跃度调整

## 总结

这次优化显著提升了宠物系统的互动体验：

✅ **更精细的反馈**: 分钟级衰减提供即时反馈  
✅ **更合理的节奏**: 3天衰减期符合工作习惯  
✅ **更好的平衡**: 避免过快或过慢的能量变化  
✅ **向后兼容**: 不影响现有功能和数据  
✅ **测试覆盖**: 保持100%测试通过率

新的衰减机制让Claude Code宠物更像一个需要持续关爱的"活"的伙伴，鼓励开发者保持编程的连续性和规律性。