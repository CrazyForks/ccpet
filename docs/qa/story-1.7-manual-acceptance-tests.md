# 故事 1.7：State Persistence - 手工验收测试文档

## 测试基本信息
- **故事编号**: 1.7  
- **故事标题**: State Persistence  
- **测试日期**: ___________  
- **测试人员**: ___________  
- **构建版本**: ___________  

## 前置条件
1. Node.js >= 20, npm >= 9
2. 项目构建成功并产生 `dist/ccpet.js`
   ```bash
   npm run build
   ```
3. CLI 可运行：
   ```bash
   node dist/ccpet.js
   ```
4. 故事 1.4（时间衰减）已实现，可用于验证跨会话的衰减恢复
5. 本机允许创建/读写 `~/.claude-pet/` 目录及其中 JSON 状态文件

## 验收标准（来自 `docs/stories/1.7.state-persistence.md`）
- **AC1**: 每次状态变化后，将当前能量保存至本地存储
- **AC2**: 扩展启动时从本地存储加载上次能量值
- **AC3**: 启动时计算上次关闭到本次启动的时间差并应用时间衰减规则

## 测试场景

### 场景1：首次运行创建状态文件（AC1）
**目标**: 验证首次运行能自动创建持久化文件，并包含必要字段。

**步骤**:
1. 删除旧状态文件（如存在）：
   ```bash
   rm -f ~/.claude-pet/pet-state.json
   ```
2. 运行 CLI：
   ```bash
   node /Users/nick/CascadeProjects/ccpet/dist/ccpet.js
   ```
3. 检查是否创建目录与文件：`~/.claude-pet/pet-state.json`
4. 查看文件内容（应为合法 JSON，并包含核心字段）：
   - `energy: number`
   - `expression: string`
   - `lastFeedTime: string(ISO)`
   - `accumulatedTokens: number`
   - `totalTokensConsumed: number`
   - `lastDecayTime?: string(ISO)`

**预期结果**:
- [ ] 首次运行后文件自动创建
- [ ] JSON 字段完整合法

**验收标准映射**: AC1（保存与文件生成）

---

### 场景2：能量变化后的自动保存（AC1）
**目标**: 验证能量发生变化（喂养/衰减）后，状态会立即保存。

**步骤（示例-喂养）**:
1. 运行 CLI 记录当前 `energy`。
2. 在测试仓库进行一次提交（参考故事 1.3，触发 token → 能量增加）：
   ```bash
   git add . && git commit -m "test: trigger energy feed"
   ```
3. 等待 ≥ 6 秒后再次运行 CLI。
4. 打开 `~/.claude-pet/pet-state.json`，验证 `energy`、`lastFeedTime` 已更新。

**预期结果**:
- [ ] 能量上升，JSON 文件同步更新
- [ ] 时间字段为最新时间（ISO 格式）

**验收标准映射**: AC1

---

### 场景3：启动加载上次状态（AC2）
**目标**: 验证扩展启动时从文件加载上次保存的能量，并正确显示表情。

**步骤**:
1. 手动编辑 `~/.claude-pet/pet-state.json` 将 `energy` 设为 `33`，`lastFeedTime` 设为当前时间；保存。
2. 运行 CLI。
3. 观察输出：应显示与 33 相符的表情（根据 1.5 阈值应为 `(u_u)`）。

**预期结果**:
- [ ] 启动后使用文件中的能量值，不重置为默认
- [ ] 表达式与能量阈值匹配

**验收标准映射**: AC2

---

### 场景4：跨会话时间衰减恢复（AC3）
**目标**: 验证关闭→再次启动时，按上次时间计算衰减。

**步骤**:
1. 将 `energy` 设为 `80`，`lastDecayTime` 设为 2 小时前（ISO 时间）。示例：
   ```json
   {
     "energy": 80,
     "expression": "(^_^)",
     "lastFeedTime": "2025-08-22T14:00:00.000Z",
     "lastDecayTime": "2025-08-22T14:00:00.000Z",
     "totalTokensConsumed": 0,
     "accumulatedTokens": 0
   }
   ```
2. 运行 CLI。
3. 依据 `DECAY_RATE = 0.0231` 点/分钟，120 分钟衰减约 `2.772`：
   - 期望能量 ≈ `80 - 2.77 = 77.23`（允许 ±0.2 容差，视实现四舍五入）
4. 观察输出能量与表情并确认已应用衰减。

**预期结果**:
- [ ] 启动时自动根据时间差衰减
- [ ] JSON 中 `lastDecayTime` 随运行更新

**验收标准映射**: AC3

---

### 场景5：缺失/损坏状态文件的容错（AC2/AC3）
**目标**: 验证文件缺失或损坏时的优雅降级与恢复。

**步骤**:
1. 将 `~/.claude-pet/pet-state.json` 改成不合法 JSON（例如删掉结尾花括号）。
2. 运行 CLI。
3. 观察程序是否崩溃；检查是否回退到默认状态并重建文件。

**预期结果**:
- [ ] 程序不崩溃，回退默认值
- [ ] 重新生成合法 JSON 文件

**验收标准映射**: AC2、AC3（启动加载与恢复流程健壮）

---

### 场景6：多次会话一致性与性能（附加）
**目标**: 验证频繁启动/退出时，保存/加载稳定且无显著性能问题。

**步骤**:
1. 连续运行 CLI 10 次，间隔 10-30 秒。
2. 检查每次 `energy` 与时间字段随逻辑变化稳定。
3. 观察运行时间（单次 <100ms 为佳）。

**预期结果**:
- [ ] 多次会话保存/加载稳定
- [ ] 无明显性能退化

---

## 测试结果汇总

### 验收标准完成情况
| 验收标准 | 状态 | 备注 |
|---------|------|------|
| AC1: 每次变化即保存 | [ ] ✅ [ ] ❌ | |
| AC2: 启动加载上次状态 | [ ] ✅ [ ] ❌ | |
| AC3: 启动时按时间衰减 | [ ] ✅ [ ] ❌ | |

### 测试场景完成情况
| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 场景1: 首次创建 | [ ] ✅ [ ] ❌ | |
| 场景2: 自动保存 | [ ] ✅ [ ] ❌ | |
| 场景3: 启动加载 | [ ] ✅ [ ] ❌ | |
| 场景4: 时间衰减 | [ ] ✅ [ ] ❌ | |
| 场景5: 容错恢复 | [ ] ✅ [ ] ❌ | |
| 场景6: 一致性性能 | [ ] ✅ [ ] ❌ | |

### 缺陷记录
| 缺陷ID | 场景 | 描述 | 严重级别 | 状态 |
|--------|------|------|----------|------|
| | | | | |

### 最终测试结论
- [ ] ✅ 接受  
- [ ] ❌ 拒绝  
- [ ] ⚠️ 有条件接受  

**测试人员签名**: ___________________  
**测试完成日期**: _________________

---

## 附录
- 故事文档: `docs/stories/1.7.state-persistence.md`
- 相关代码: `src/services/PetStorage.ts`、`src/core/Pet.ts`、`src/ccpet.ts`
- 参考文档: `docs/qa/story-1.4-manual-acceptance.md`（时间衰减验证示例）
