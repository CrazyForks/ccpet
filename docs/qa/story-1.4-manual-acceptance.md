# 故事1.4手工验收文档 - 时间流逝功能

## 基本信息
- **故事编号**: 1.4
- **故事名称**: The Passage of Time (时间流逝)
- **验收日期**: 2025-08-22
- **验收人员**: [待填写]
- **开发人员**: James (Dev Agent)

## 功能概述
实现基于时间的宠物能量衰减系统，当长时间没有编程活动时，宠物能量会自动降低，提醒开发者关注宠物状态。

## 验收标准 (AC)

### AC1: 系统具有定时器功能
**预期行为**: 系统能够检测时间间隔并触发能量衰减
**验收步骤**:
1. 检查配置文件 `src/core/config.ts` 中是否包含以下配置:
   - `DECAY_CHECK_INTERVAL: 60000` (1分钟，毫秒)
   - `DECAY_RATE: 0.0231` (每分钟衰减0.0231点能量)
   - `MINIMUM_DECAY_INTERVAL: 60000` (最小衰减间隔1分钟)

**验收结果**: [ ] 通过 / [ ] 失败
**备注**: _______________

### AC2: 无编程活动时触发能量衰减
**预期行为**: 当超过设定时间间隔且无活动时，调用能量衰减函数
**验收步骤**:
1. 运行CLI脚本: `./dist/ccpet.js`
2. 查看控制台输出，确认没有"Applying time decay"消息 (因为刚运行)
3. 手动修改宠物状态文件 `~/.claude-pet/pet-state.json`，将 `lastFeedTime` 设置为2小时前:
   ```json
   {
     "energy": 80,
     "expression": "(^_^)",
     "lastFeedTime": "2025-08-22T14:00:00.000Z",
     "totalTokensConsumed": 0
   }
   ```
4. 再次运行CLI脚本: `./dist/ccpet.js`
5. 查看控制台输出，应该看到类似: "Applying time decay: 2.77 energy after 120.0 minutes"
6. 检查能量值是否从80降到约77.23 (120分钟 × 0.0231点/分钟 = 2.77点衰减)

**验收结果**: [ ] 通过 / [ ] 失败
**备注**: _______________

### AC3: 状态栏能量条更新反映衰减
**预期行为**: 能量衰减后，状态栏显示更新的能量条和表情
**验收步骤**:
1. 继续上面的测试，检查CLI输出的状态显示
2. 能量条应该反映新的能量值 (70/100)
3. 如果能量下降到不同阈值，表情应该相应变化:
   - ≥80: `(^_^)` 开心
   - 40-79: `(o_o)` 饥饿  
   - 10-39: `(u_u)` 生病
   - <10: `(x_x)` 死亡

**验收结果**: [ ] 通过 / [ ] 失败
**备注**: _______________

## 详细功能测试

### 测试用例1: 基本时间衰减功能
**目的**: 验证基本的时间衰减计算逻辑
**步骤**:
1. 设置初始状态: 能量100，1小时前最后喂食
2. 运行CLI脚本
3. 验证能量减少约1.39点 (100 → 98.61)
4. 验证控制台输出显示"Applying time decay: 1.39 energy after 60.0 minutes"

**预期结果**: 能量正确衰减，日志输出正确
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

### 测试用例2: 多间隔衰减
**目的**: 验证多个时间间隔的累积衰减
**步骤**:
1. 设置初始状态: 能量100，3小时前最后喂食
2. 运行CLI脚本
3. 验证能量减少约4.16点 (100 → 95.84)
4. 验证日志显示"Applying time decay: 4.16 energy after 180.0 minutes"

**预期结果**: 多间隔衰减计算正确
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

### 测试用例3: 最小间隔限制
**目的**: 验证未达到最小衰减间隔时不会衰减
**步骤**:
1. 设置初始状态: 能量100，30秒前最后喂食 (少于1分钟)
2. 运行CLI脚本
3. 验证能量保持100不变
4. 验证没有衰减日志输出

**预期结果**: 未达到最小间隔时不衰减
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

### 测试用例4: 能量下限保护
**目的**: 验证能量不会低于0
**步骤**:
1. 设置初始状态: 能量2，2小时前最后喂食
2. 运行CLI脚本 (应该衰减2.77点，但能量只有2点)
3. 验证能量降为0而不是负数
4. 验证表情变为死亡状态 `(x_x)`

**预期结果**: 能量正确限制在0，表情更新为死亡状态
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

### 测试用例5: lastDecayTime优先级
**目的**: 验证使用lastDecayTime而非lastFeedTime进行计算
**步骤**:
1. 手动编辑状态文件，设置:
   - `lastFeedTime`: 3小时前
   - `lastDecayTime`: 1小时前
   - `energy`: 50
2. 运行CLI脚本
3. 验证衰减基于lastDecayTime (1小时前) 而非lastFeedTime (3小时前)
4. 验证能量减少约1.39点 (50 → 48.61)

**预期结果**: 正确使用lastDecayTime进行计算
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

### 测试用例6: 表情状态转换
**目的**: 验证能量衰减时表情正确更新
**步骤**:
1. 设置初始状态: 能量83 (开心状态)，2小时前最后喂食
2. 运行CLI脚本
3. 验证能量从83降到约80.23 (刚好在开心阈值80边缘)
4. 验证表情保持 `(^_^)` 或变为 `(o_o)` (取决于具体衰减值)

**预期结果**: 表情根据新能量值正确更新
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

## 错误处理测试

### 测试用例7: 无效时间处理
**目的**: 验证系统对无效时间数据的容错性
**步骤**:
1. 手动破坏状态文件中的时间格式
2. 运行CLI脚本
3. 验证程序不会崩溃
4. 验证显示基本状态而非错误

**预期结果**: 优雅处理错误，不崩溃
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

## 性能测试

### 测试用例8: 响应时间
**目的**: 验证CLI执行性能符合要求
**步骤**:
1. 多次运行CLI脚本并记录执行时间
2. 验证每次执行时间 < 100ms

**预期结果**: 执行时间符合性能要求
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

## 集成测试

### 测试用例9: 与喂食功能集成
**目的**: 验证时间衰减与喂食功能正常配合
**步骤**:
1. 设置能量50，1小时前最后喂食
2. 创建包含token的JSONL文件
3. 运行CLI脚本处理token (模拟喂食)
4. 验证先应用时间衰减 (50→48.61)，再应用喂食 (48.61→增加)

**预期结果**: 先衰减后喂食的顺序正确
**实际结果**: _______________
**状态**: [ ] 通过 / [ ] 失败

## 配置验证

### 测试用例10: 配置常量验证
**目的**: 验证所有配置常量正确定义
**步骤**:
1. 检查 `src/core/config.ts` 文件
2. 验证 `TIME_DECAY` 配置对象包含所有必需字段
3. 验证数值类型和合理性

**预期配置值**:
```typescript
TIME_DECAY: {
  DECAY_CHECK_INTERVAL: 60000,    // 1分钟
  DECAY_RATE: 0.0231,             // 每分钟0.0231点能量
  MINIMUM_DECAY_INTERVAL: 60000   // 最小1分钟间隔
}
```

**验收结果**: [ ] 通过 / [ ] 失败
**备注**: _______________

## 总体验收结果

### 测试结果汇总
- **通过测试用例**: ___/10
- **失败测试用例**: ___/10
- **总体通过率**: ___%

### 验收决定
[ ] **通过验收** - 所有关键功能正常，可以发布
[ ] **有条件通过** - 大部分功能正常，有轻微问题需要记录
[ ] **不通过验收** - 存在严重问题，需要返工

### 备注和建议
_________________________________
_________________________________
_________________________________

### 验收人员签名
**验收人**: _______________
**日期**: _______________
**签名**: _______________

---
*此文档基于故事1.4的需求和AC标准编写，用于手工验收测试。*