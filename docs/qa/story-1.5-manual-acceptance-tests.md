# 故事 1.5：Emotional Expressions - 手工验收测试文档

## 测试基本信息
- **故事编号**: 1.5  
- **故事标题**: Emotional Expressions  
- **测试日期**: ___________  
- **测试人员**: ___________  
- **构建版本**: ___________  

## 前置条件
1. 已安装 Node.js >= 20 与 npm >= 9
2. 项目构建成功并产生 `dist/ccpet.js`
   ```bash
   npm run build
   ```
3. CLI 可从项目根目录运行：
   ```bash
   node dist/ccpet.js
   ```
4. 已完成并可用的前置故事：`1.2 Energy Logic Core`、`1.3 Feeding the Pet`、`1.7 State Persistence`
5. 本机有读写 `~/.claude-pet/` 目录与 `~/.claude-pet/pet-state.json` 文件的权限

## 验收标准（来自 `docs/stories/1.5.emotional-expressions.md`）
- **AC1**: 当能量值 > 80% 时显示“开心/跳舞”表情
- **AC2**: 当能量值 < 40% 时显示“饥饿”表情
- **AC3**: 当能量值 < 10% 时显示“生病”表情
- **AC4**: 当能量值 = 0 时显示“死亡”表情

> 说明：阈值边界采用降序判断（参考故事1.2与1.5的一致性）：
> - 能量 ≥ 80: 开心 `(^_^)`
> - 40 ≤ 能量 < 80: 饥饿 `(o_o)`
> - 10 ≤ 能量 < 40: 生病 `(u_u)`
> - 能量 = 0: 死亡 `(x_x)`

## 测试场景

### 场景1：配置与常量核对（AC1-AC4）
**目标**: 确认阈值与表情配置正确，便于后续判断逻辑的准确性。

**步骤**:
1. 打开 `src/core/config.ts`
2. 核对以下配置存在且取值正确：
   - `STATE_THRESHOLDS`：`HAPPY: 80`、`HUNGRY: 40`、`SICK: 10`、`DEAD: 0`
   - `STATE_EXPRESSIONS`：`HAPPY: '(^_^)'`、`HUNGRY: '(o_o)'`、`SICK: '(u_u)'`、`DEAD: '(x_x)'`
3. 打开 `src/core/Pet.ts`，确认存在并使用 `_updateExpression()` 依据阈值更新表情；在 `addEnergy()`、`decreaseEnergy()` 后调用。
4. 打开 `src/ui/StatusBar.ts`，确认 `formatPetDisplay()` 首段包含表情字符串。

**预期结果**:
- [ ] 阈值与表情常量符合定义
- [ ] `Pet` 能量变更后会调用 `_updateExpression()`
- [ ] 状态栏格式包含表情展示

**验收标准映射**: AC1-AC4 依据上述常量与逻辑生效

---

### 场景2：阈值边界映射测试（AC1-AC4）
**目标**: 验证在关键阈值与邻近值时，表情显示与定义相符。

**准备**:
- 确保 `~/.claude-pet/pet-state.json` 存在（若不存在可先运行一次 CLI 自动创建）。

**步骤**（对每个能量值重复以下流程）：
1. 编辑 `~/.claude-pet/pet-state.json`，仅修改 `energy` 与时间字段（`lastFeedTime`、`lastDecayTime`）为当前时间；保存。
2. 运行：
   ```bash
   node /Users/nick/CascadeProjects/ccpet/dist/ccpet.js
   ```
3. 观察输出中的表情与能量条。

| 能量设定 | 期望表情 | 通过 | 备注 |
|----------|----------|------|------|
| 100 | `(^_^)` | [ ] | |
| 80 | `(^_^)` | [ ] | |
| 79 | `(o_o)` | [ ] | |
| 40 | `(o_o)` | [ ] | |
| 39 | `(u_u)` | [ ] | |
| 10 | `(u_u)` | [ ] | |
| 1 | `(u_u)` | [ ] | |
| 0 | `(x_x)` | [ ] | |

**验收标准映射**: 
- AC1（≥80为开心）
- AC2（<40为饥饿，含39）
- AC3（<10为生病，含1；10本身应为生病区间上界，参照实现）
- AC4（=0为死亡）

---

### 场景3：能量变化触发表情实时更新（AC1-AC3）
**目标**: 验证在能量跨越阈值时，表情随之更新。

**步骤（示例）**:
1. 将 `energy` 设为 `78`（应显示 `(o_o)`）。
2. 在测试仓库做小幅代码更改并提交（触发 token → 能量增加，参考故事1.3）：
   ```bash
   git add . && git commit -m "test: trigger energy feed"
   ```
3. 等待 ≥ 6 秒（`MIN_TIME_BETWEEN_FEEDS`）。
4. 执行 CLI 并观察输出表情是否变为 `(^_^)`（能量跨过 80）。

**预期结果**: 跨越阈值后，表情即时更新且与能量一致。

**验收标准映射**: AC1-AC3

---

### 场景4：状态栏显示格式与可读性（AC1-AC4）
**目标**: 验证表情位于显示的首段，整体格式清晰、未被截断。

**步骤**:
1. 运行 CLI，记录状态栏/输出的首段。
2. 调整终端宽度，确认表情始终可见。

**预期结果**:
- [ ] 输出形如：`(^_^) ●●●●●●●●●●` 或同等样式
- [ ] 缩放终端后仍可读，不被截断

**验收标准映射**: AC1-AC4（表现层验证）

---

### 场景5：下限保护与死亡表达（AC4）
**目标**: 验证能量不为负且为0时显示死亡表情。

**步骤**:
1. 设置 `energy: 1`，运行 CLI，记录表情为 `(u_u)`。
2. 将 `lastFeedTime`/`lastDecayTime` 设置为足够久远（例如 3 小时前），运行 CLI，若衰减逻辑使能量降到 0：
3. 观察表情变为 `(x_x)`，且能量不出现负值。

**预期结果**: 能量下限为 0，表情为 `(x_x)`。

**验收标准映射**: AC4

---

## 测试结果汇总

### 验收标准完成情况
| 验收标准 | 状态 | 备注 |
|---------|------|------|
| AC1: ≥80 显示开心 | [ ] ✅ [ ] ❌ | |
| AC2: <40 显示饥饿 | [ ] ✅ [ ] ❌ | |
| AC3: <10 显示生病 | [ ] ✅ [ ] ❌ | |
| AC4: =0 显示死亡 | [ ] ✅ [ ] ❌ | |

### 测试场景完成情况
| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 场景1: 配置核对 | [ ] ✅ [ ] ❌ | |
| 场景2: 阈值边界 | [ ] ✅ [ ] ❌ | |
| 场景3: 实时更新 | [ ] ✅ [ ] ❌ | |
| 场景4: 显示格式 | [ ] ✅ [ ] ❌ | |
| 场景5: 下限保护 | [ ] ✅ [ ] ❌ | |

### 缺陷记录
| 缺陷ID | 场景 | 描述 | 严重级别 | 状态 |
|--------|------|------|----------|------|
| | | | | |

### 最终测试结论
- [ ] ✅ 接受  
- [ ] ❌ 拒绝  
- [ ] ⚠️ 有条件接受  

**测试人员签名**: ___________________  
**测试完成日期**: _________________

---

## 附录
- 故事文档: `docs/stories/1.5.emotional-expressions.md`
- 相关代码: `src/core/config.ts`、`src/core/Pet.ts`、`src/ui/StatusBar.ts`
- 参考文档: 故事 `1.2`、`1.3`、`1.4`、`1.7` 的手工验收文档
