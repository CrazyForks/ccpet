# 手工验收测试 - 故事1.3：喂养宠物

## 测试信息

- **故事编号**: 1.3 - 喂养宠物
- **创建日期**: 2025-08-22
- **测试环境**: macOS/Linux CLI执行环境
- **前置条件**: 故事1.1和1.2已完成并验证通过

## 验收标准

1. **验收标准1**: 扩展能够监控编辑器中的编码活动以跟踪Token消耗
2. **验收标准2**: Token消耗调用能量模块的"add"功能
3. **验收标准3**: 状态栏能量条实时（或接近实时）更新以反映能量增加

## 测试准备

### 前置条件检查

- [ ] 项目构建成功 (`npm run build`)
- [ ] 所有单元测试通过 (`npm test`)
- [ ] CLI可执行文件位于 `dist/extension.js`
- [ ] 测试目录已初始化Git仓库
- [ ] Claude Code已配置使用宠物扩展

### 测试数据准备

- 包含源代码文件的测试项目 (`.ts`, `.js`等)
- 初始宠物状态能量较低 (< 50%) 以便观察变化
- 干净的git工作目录作为基线测试

## 手工测试用例

### 测试用例1：初始基线能量检查

**测试目标**: 验证宠物在任何活动之前显示当前能量状态

**测试步骤**:

1. 执行CLI命令: `node dist/extension.js`
2. 记录当前能量水平和表情
3. 等待10秒后再次执行
4. 验证能量保持稳定（短时间内无衰减）

**预期结果**:

- 宠物显示能量条 (例如: `(^_^) ██████████`)
- 快速连续执行时能量水平保持一致
- 表情符合故事1.2的能量阈值设定

**通过/失败**: [ ]

---

### 测试用例2：Git提交活动检测

**测试目标**: 验证当进行git提交时宠物能量增加

**前置条件**:

- 记录初始能量水平
- 确保CLI执行间隔至少6秒 (MIN_TIME_BETWEEN_FEEDS)

**测试步骤**:

1. 执行CLI并记录基线: `node dist/extension.js`
2. 创建/修改源代码文件 (添加10+行代码)
3. 暂存更改: `git add .`
4. 提交更改: `git commit -m "测试宠物喂养的提交"`
5. 等待6秒
6. 再次执行CLI: `node dist/extension.js`
7. 对比能量水平

**预期结果**:

- 能量水平从基线增加
- 能量条显示更多填充段
- 如果能量之前较低，表情可能变为更快乐的状态
- 变化在后续CLI调用中持续存在

**通过/失败**: [ ]

---

### 测试用例3：文件修改活动检测

**测试目标**: 验证宠物从文件系统变化中获得能量

**前置条件**:

- 记录初始能量水平
- 确保git工作目录干净

**测试步骤**:

1. 执行CLI并记录基线: `node dist/extension.js`
2. 修改现有源代码文件 (更改5+行)
3. 创建新的源代码文件 (.ts, .js, .py等)
4. 等待6秒
5. 再次执行CLI: `node dist/extension.js`
6. 对比能量水平

**预期结果**:

- 能量水平从基线增加
- 未提交的文件更改触发token检测
- 能量增加与修改文件数量成正比
- 变化在CLI执行间持续存在

**通过/失败**: [ ]

---

### 测试用例4：最小喂养间隔保护

**测试目标**: 验证防刷保护机制正常工作

**测试步骤**:

1. 执行CLI: `node dist/extension.js`
2. 进行重大代码更改 (提交新文件)
3. 立即再次执行CLI (< 5秒): `node dist/extension.js`
4. 等待6秒
5. 再次执行CLI: `node dist/extension.js`

**预期结果**:

- 步骤3: 无能量增加 (距离上次执行时间太短)
- 步骤5: 检测到代码更改，能量增加
- 保护机制防止能量刷取

**通过/失败**: [ ]

---

### 测试用例5：能量边界和限制

**测试目标**: 验证能量保持在0-100边界内且有限制

**测试步骤**:

1. 从高能量宠物开始 (90%+)
2. 进行大规模更改 (20+文件, 100+行)
3. 提交更改
4. 等待6秒
5. 执行CLI: `node dist/extension.js`

**预期结果**:

- 能量上限为100% (10个满格)
- 不会超出最大能量值
- 表情显示最快乐状态 `(^_^)`
- 应用MAX_TOKENS_PER_SESSION限制

**通过/失败**: [ ]

---

### 测试用例6：错误处理和优雅降级

**测试目标**: 验证系统优雅处理错误

**测试6a: Git命令失败**

**测试步骤**:

1. 移动到非git目录: `cd /tmp`
2. 执行CLI: `node /path/to/dist/extension.js`

**预期结果**:

- CLI执行不崩溃
- 回退到文件系统检测或返回0个token
- 宠物状态保持稳定

**通过/失败**: [ ]

**测试6b: 文件系统权限问题**

**测试步骤**:

1. 创建权限受限的目录
2. 从该目录执行CLI

**预期结果**:

- 无崩溃或未处理异常
- 优雅回退到当前宠物状态
- 错误信息（如有）输出到stderr而非stdout

**通过/失败**: [ ]

---

### 测试用例7：会话间状态持久化

**测试目标**: 验证token监控状态正确持久化

**测试步骤**:

1. 执行CLI并记录初始状态
2. 进行代码更改并提交
3. 执行CLI获得能量
4. 检查 `~/.claude-pet/` 目录中的状态文件
5. 重启系统/终端会话
6. 再次执行CLI
7. 进行新更改并执行CLI

**预期结果**:

- 创建 `pet-state.json` 和 `token-monitor-state.json`
- 状态文件包含有效JSON和预期字段
- 宠物能量在会话间持续存在
- Token监控记住上次执行时间和git提交
- 后续更改被正确检测

**通过/失败**: [ ]

---

### 测试用例8：不同文件类型和扩展名

**测试目标**: 验证检测适用于各种源代码文件类型

**测试步骤**:

1. 创建/修改不同扩展名的文件:
   - `.ts` (TypeScript)
   - `.js` (JavaScript)
   - `.py` (Python)
   - `.java` (Java)
   - `.cpp` (C++)
   - `.rs` (Rust)
2. 同时创建非源代码文件:
   - `.md` (Markdown)
   - `.json` (JSON)
   - `.txt` (文本)
3. 提交所有更改
4. 等待6秒
5. 执行CLI

**预期结果**:

- 只有源代码文件更改计入token数量
- 文件系统检测忽略非源代码文件
- 根据更改的源代码文件数量获得适当能量

**通过/失败**: [ ]

---

### 测试用例9：混合检测模式验证

**测试目标**: 验证混合检测使用git和文件系统检测的最佳结果

**测试步骤**:

1. 进行更改并提交 (git检测)
2. 进行额外未提交更改 (文件系统检测)
3. 等待6秒
4. 执行CLI

**预期结果**:

- 能量增加反映已提交和未提交的更改
- 混合模式采用git和文件系统检测的最大值
- 正确计算总token数量

**通过/失败**: [ ]

---

### 测试用例10：Claude Code集成测试

**测试目标**: 验证与Claude Code状态栏的集成

**前置条件**:

- 已安装并配置Claude Code
- 在Claude Code设置中配置宠物扩展

**测试步骤**:

1. 在Claude Code中配置宠物扩展:
   ```json
   {
     "statusLine": {
       "type": "command", 
       "command": "/path/to/ccpet/dist/extension.js"
     }
   }
   ```
2. 打开Claude Code
3. 验证宠物出现在状态栏
4. 在编辑器中进行代码更改
5. 观察状态栏更新

**预期结果**:

- 宠物在Claude Code状态栏中正确显示
- 能量更新反映编码活动
- 无性能问题或延迟
- 状态栏适当刷新

**通过/失败**: [ ]

## 配置测试

### 测试用例11：Token到能量转换率

**测试目标**: 验证可配置转换率正常工作

**测试步骤**:

1. 修改 `src/core/config.ts` 中的 `TOKEN_MONITOR_CONFIG`:
   - 将 `TOKEN_TO_ENERGY_RATE` 改为2 (每token 2能量)
   - 将 `TOKENS_PER_LINE_CHANGE` 改为2 (每行2 token)
2. 重新构建: `npm run build`
3. 进行5行更改并提交
4. 执行CLI

**预期结果**:

- 能量增加 = 5行 × 2 token/行 × 2 能量/token = 20能量
- 配置更改正确应用
- 能量计算遵循新比率

**通过/失败**: [ ]

## 性能测试

### 测试用例12：CLI执行性能

**测试目标**: 验证CLI性能满足要求

**测试步骤**:

1. 计时CLI执行: `time node dist/extension.js`
2. 在大型仓库中重复测试 (1000+文件)
3. 测试深层目录结构

**预期结果**:

- 正常仓库CLI在< 100ms内完成
- 大型代码库无明显性能下降
- 内存使用保持合理

**通过/失败**: [ ]

## 边界情况

### 测试用例13：空仓库

**测试步骤**:

1. 创建空git仓库
2. 执行CLI

**预期结果**:

- 无崩溃
- 显示默认宠物状态
- 检测到零token

**通过/失败**: [ ]

### 测试用例14：非Git目录

**测试步骤**:

1. 在无git的目录中执行CLI
2. 验证文件系统检测仍然工作

**预期结果**:

- 仅回退到文件系统检测
- 文件更改仍被检测和奖励
- 无git相关错误

**通过/失败**: [ ]

## 测试总结

### 整体测试结果

- **测试用例总数**: 14
- **通过**: ___
- **失败**: ___
- **跳过**: ___

### 验收标准确认

- [ ] **验收标准1**: 通过git和文件系统检测验证token监控
- [ ] **验收标准2**: 确认Pet.addEnergy()集成和能量增加
- [ ] **验收标准3**: Claude Code中实时状态栏更新正常工作

### 签收

- **测试人员**: _________________
- **日期**: _________________
- **总体结果**: 通过 / 失败
- **备注**: _________________

## 故障调查

如果任何测试失败，请调查:

1. 检查控制台输出的错误信息
2. 验证 `~/.claude-pet/` 中的状态文件
3. 检查git仓库状态和历史
4. 验证文件修改时间戳
5. 查看CLI构建输出和依赖项

## 自动化说明

以下测试用例可在未来迭代中自动化:

- 测试用例1-9 (核心功能)
- 性能测试 (测试用例12)
- 边界情况 (测试用例13-14)

以下方面仍需手工测试:

- Claude Code集成 (测试用例10)
- 用户体验验证
- 能量条变化的视觉确认