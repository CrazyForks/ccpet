# 手动验收测试 - 故事 1.6：新的开始

## 故事摘要
**作为** 开发者，  
**我希望** 我的宠物在完全死亡时自动重置，  
**以便** 我可以从头开始重新培养体验。

## 验收标准

1. 当宠物能量降到 0 时，自动清零所有 token 统计数据
2. 清零 totalLifetimeTokens, totalTokensConsumed, 和 accumulatedTokens 到 0
3. 宠物重新开始 - 新消耗的 token 将从零开始重建宠物

---

## 手动测试用例

### 测试用例 1：能量降到0时自动清零token统计 (验收标准：1, 2)
**测试目标**：验证当宠物能量降到0时，所有token统计数据自动清零。

**前置条件**：
- 宠物有一定的token统计数据（totalLifetimeTokens > 0, totalTokensConsumed > 0）
- 宠物能量接近0但未到0

**测试步骤**：
1. 记录当前token统计数据值
2. 等待足够时间让能量衰减到0，或手动设置能量为0
3. 检查宠物状态显示变为 `(x_x) ○○○○○○○○○○ 0.00 (0)`
4. 检查状态文件 `~/.claude-pet/pet-state.json` 中的token统计值

**预期结果**：
- ✅ 宠物表情变为 `(x_x)` 死亡状态
- ✅ totalLifetimeTokens 清零为 0
- ✅ totalTokensConsumed 清零为 0
- ✅ accumulatedTokens 清零为 0

**实际结果**：
- [ ] 通过 ✅
- [ ] 失败 ❌ 
- **备注**： 

---

### 测试用例 2：死亡后新token从零开始重建宠物 (验收标准：3)
**测试目标**：验证宠物死亡后，新的token消耗从零开始重建宠物。

**前置条件**：
- 宠物已死亡（能量 = 0，所有token统计已清零）

**测试步骤**：
1. 确认宠物处于死亡状态：`(x_x) ○○○○○○○○○○ 0.00 (0)`
2. 开始使用Claude Code产生新的token消耗
3. 观察状态变化，检查token是否从0开始累积
4. 验证能量是否从0开始逐渐恢复

**预期结果**：
- ✅ 新token从0开始累积
- ✅ 能量从0开始逐渐恢复
- ✅ 宠物表情从 `(x_x)` 逐步恢复到其他状态
- ✅ 所有统计数据从零开始重新计算

**实际结果**：
- [ ] 通过 ✅
- [ ] 失败 ❌ 
- **备注**： 

---

### 测试用例 3：状态文件持久化验证 (验收标准：1, 2)
**测试目标**：验证死亡重置后的状态正确保存到文件。

**前置条件**：
- 宠物刚死亡并完成自动重置

**测试步骤**：
1. 宠物死亡后，检查状态文件 `~/.claude-pet/pet-state.json`
2. 验证文件中的各项数值
3. 重启Claude Code会话
4. 再次检查状态显示是否与文件一致

**预期结果**：
- ✅ 状态文件中 energy = 100（初始值）
- ✅ 状态文件中 totalLifetimeTokens = 0
- ✅ 状态文件中 totalTokensConsumed = 0
- ✅ 状态文件中 accumulatedTokens = 0
- ✅ 重启后状态显示与文件一致

**实际结果**：
- [ ] 通过 ✅
- [ ] 失败 ❌ 
- **备注**： 

---

### 测试用例 4：多次死亡重置验证 (验收标准：1, 2, 3)
**测试目标**：验证宠物可以多次死亡和重置。

**前置条件**：
- 宠物已经历过一次死亡重置

**测试步骤**：
1. 让重置后的宠物再次积累一些token
2. 再次让能量衰减到0
3. 验证第二次死亡时token统计再次清零
4. 验证第二次重置后可以正常重新开始

**预期结果**：
- ✅ 第二次死亡时所有token统计再次清零
- ✅ 第二次重置后能正常从零开始积累
- ✅ 每次重置行为一致
- ✅ 无状态残留或累积问题

**实际结果**：
- [ ] 通过 ✅
- [ ] 失败 ❌ 
- **备注**： 

---

### 测试用例 5：CLI模式死亡重置
**测试目标**：验证死亡重置功能在纯CLI模式下正确工作。

**前置条件**：
- 宠物处于死亡状态
- CLI执行环境（Claude Code状态栏）

**测试步骤**：
1. 直接运行CLI：`npx ccpet@latest`
2. 验证死亡状态输出显示清零的token统计
3. 模拟新的token消耗（通过修改转录文件）
4. 再次运行CLI验证重建过程

**预期结果**：
- ✅ CLI显示死亡宠物状态：`(x_x) ○○○○○○○○○○ 0.00 (0)`
- ✅ 新token消耗后状态开始从零重建
- ✅ CLI模式无错误或崩溃
- ✅ 自动死亡重置机制正常工作

**实际结果**：
- [ ] 通过 ✅
- [ ] 失败 ❌ 
- **备注**： 

---

### 测试用例 6：错误处理和边缘情况
**测试目标**：验证死亡重置在错误场景下正确表现。

**前置条件**：
- 各种宠物状态和系统条件

**测试步骤**：
1. **文件权限问题**：移除 `~/.claude-pet/` 目录的写权限，触发死亡重置
2. **损坏的状态文件**：手动损坏宠物状态JSON文件，然后触发死亡
3. **极端能量值**：手动设置负数或非数字能量值
4. **并发访问**：多个进程同时访问状态文件

**预期结果**：
- ✅ 文件权限错误优雅处理（记录日志，不崩溃）
- ✅ 损坏的状态文件导致回退到默认死亡重置状态
- ✅ 极端值被正确处理和重置
- ✅ 并发访问不会造成数据损坏

**实际结果**：
- [ ] 通过 ✅
- [ ] 失败 ❌ 
- **备注**： 

---

## 测试总结

**测试执行日期**：`___________`  
**测试员**：`___________`  
**环境**：`___________`  

### 结果摘要：
- **总测试用例数**：6
- **通过**：`___/6`
- **失败**：`___/6`
- **总体结果**：[ ] 通过 ✅ | [ ] 失败 ❌

### 发现的关键问题：
- [ ] 无
- [ ] 列出任何阻止验收的关键问题：

### 次要问题或改进建议：
- [ ] 无  
- [ ] 列出任何次要问题或建议的改进：

### 验收决定：
- [ ] **已验收** - 所有验收标准已满足 ✅
- [ ] **已拒绝** - 关键问题阻止验收 ❌
- [ ] **有条件验收** - 次要问题，可接受后续工作 ⚠️

**QA审查员签名**：`________________` **日期**：`__________`